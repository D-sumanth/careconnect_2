<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Information Dashboard - CareConnect</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/dashboard.css" />
    <link rel="stylesheet" href="/css/vertical-nav.css" />
    <!-- Add Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="sidebar">
      <header>
        <h1 class="logo">
          <span class="blue-c">C</span>are<span class="blue-c">C</span>onnect
        </h1>
      </header>

      <nav class="vertical-nav">
        <ul>
          <li>
            <a href="index.html">
              <i class="fas fa-home"></i>
              <span>Home</span>
            </a>
          </li>
          <li>
            <a href="policies.html">
              <i class="fas fa-book"></i>
              <span>Policies</span>
            </a>
          </li>
          <li>
            <a href="dashboard.html" class="active">
              <i class="fas fa-chart-line"></i>
              <span>Admin Dashboard</span>
            </a>
          </li>
          <li>
            <a href="staff-dashboard.html">
              <i class="fas fa-users"></i>
              <span>Staff Dashboard</span>
            </a>
          </li>
          <li>
            <a href="invoices.html">
              <i class="fas fa-receipt"></i>
              <span>Invoices</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <div class="main-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-share-alt"></i>
          </div>
          <div class="stat-details">
            <h3>Total Information Shared</h3>
            <p class="stat-number" id="totalInformation">0</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-details">
            <h3>Acknowledged</h3>
            <p class="stat-number" id="acknowledgedCount">0</p>
            <p class="stat-percentage" id="acknowledgedPercentage">0%</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-details">
            <h3>Pending</h3>
            <p class="stat-number" id="pendingCount">0</p>
            <p class="stat-percentage" id="pendingPercentage">0%</p>
          </div>
        </div>
      </div>

      <!-- Department Breakdown Section -->
      <div class="dashboard-section">
        <h2>Department Acknowledgment Status</h2>
        <div class="chart-container">
          <canvas id="departmentChart"></canvas>
        </div>
        <div class="table-container">
          <table class="department-table">
            <thead>
              <tr>
                <th>Department</th>
                <th>Total Notices</th>
                <th>Acknowledged</th>
                <th>Pending</th>
              </tr>
            </thead>
            <tbody id="departmentTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let departmentChart;

        async function fetchDashboardData() {
          try {
            const response = await fetch("/api/dashboard-stats");
            const data = await response.json();

            updateInfoStats(data.infoStats);
            updateDepartmentData(data.departmentStats);
          } catch (error) {
            console.error("Error fetching dashboard data:", error);
          }
        }

        function updateInfoStats(stats) {
          // Update numbers
          document.getElementById("totalInformation").textContent =
            stats.totalInformation;
          document.getElementById("acknowledgedCount").textContent =
            stats.acknowledgedCount;
          document.getElementById("pendingCount").textContent =
            stats.pendingCount;

          // Calculate and update percentages
          const acknowledgedPercentage =
            Math.round(
              (stats.acknowledgedCount / stats.totalInformation) * 100
            ) || 0;
          const pendingPercentage =
            Math.round((stats.pendingCount / stats.totalInformation) * 100) ||
            0;

          document.getElementById(
            "acknowledgedPercentage"
          ).textContent = `${acknowledgedPercentage}%`;
          document.getElementById(
            "pendingPercentage"
          ).textContent = `${pendingPercentage}%`;
        }

        function updateDepartmentData(departmentStats) {
          // Update department chart
          const labels = departmentStats.map((dept) => dept.department);
          const acknowledged = departmentStats.map((dept) => dept.acknowledged);
          const pending = departmentStats.map((dept) => dept.pending);

          if (departmentChart) {
            departmentChart.destroy();
          }

          const departmentCtx = document
            .getElementById("departmentChart")
            .getContext("2d");
          departmentChart = new Chart(departmentCtx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Acknowledged",
                  data: acknowledged,
                  backgroundColor: "#2196f3",
                },
                {
                  label: "Pending",
                  data: pending,
                  backgroundColor: "#ff9800",
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                x: { stacked: true },
                y: { stacked: true },
              },
            },
          });

          // Update department table
          const tableBody = document.getElementById("departmentTableBody");
          tableBody.innerHTML = departmentStats
            .map(
              (dept) => `
                <tr>
                    <td>${dept.department}</td>
                    <td>${dept.totalNotices}</td>
                    <td>${dept.acknowledged}</td>
                    <td>${dept.pending}</td>
                </tr>
            `
            )
            .join("");
        }

        // Initial load
        fetchDashboardData();

        // Refresh data every 5 minutes
        setInterval(fetchDashboardData, 5 * 60 * 1000);
      });
    </script>
  </body>
</html>
